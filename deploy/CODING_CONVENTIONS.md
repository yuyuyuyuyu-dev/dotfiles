# コーディング規約

このドキュメントは、`deploy` ディレクトリ内の Python スクリプトに関するコーディング規約を定めたものです。

## 1. 全体構成

-   **実行ハンドラ (`handlers`)**: `deploy_to_<platform>.py`（例: `deploy_to_mac.py`）のような、プラットフォームごとの実行スクリプトを `deploy/handlers` ディレクトリに配置します。このスクリプトは、各セットアップ処理を呼び出す「司令塔」の役割に徹し、具体的なロジックは持ちません。
-   **共通モジュール (`shared`)**: OSに依存しない共通の処理（シンボリックリンク作成、各設定のセットアップなど）は、`deploy/shared` ディレクトリ内に格納します。


## 2. モジュールの設計

-   **1ファイル = 1責務**: 各設定（例: Zsh, Git, Tmux）のセットアップ処理は、それぞれ独立したPythonファイル（モジュール）として作成します。（例: `setup_zsh.py`, `setup_git.py`）
-   **1ファイル = 1公開関数**: 各モジュールは、原則として外部に公開する（他のファイルから `import` して使う）関数を1つにします。
    -   公開する関数名は、モジュール名（ファイル名から `.py` を除いたもの）と同じにすることを推奨します。（例: `setup_zsh.py` なら `def setup_zsh():`）
    -   これにより、呼び出し側は `from <module_name> import <function_name>` という一貫した形式で利用できます。
-   **パスの管理**: 複数のスクリプトから参照される可能性のあるパス（例: `~/.config`）は、`shared/paths.py` に変数としてまとめて定義し、各スクリプトからはその変数をインポートして利用します。これにより、パスの変更に強く、再利用性の高いコードを維持します。
-   **関数定義の順序**: ファイル内で複数の関数を定義する場合、外部に公開する関数（`main` 関数など）をファイルの先頭に近い位置に記述し、その関数から呼び出されるプライベートなヘルパー関数（`_` で始まる関数）は、その後に記述してください。
-   **ファイル名と関数名**: 汎用的なヘルパー関数（例: `create_symlink_safely`）を作成する場合、ファイル名はその代表的な関数名を反映させます。（例: `create_symlink_safely.py`）

## 3. インポートの管理

このスクリプト群は、`python3 -m deploy <platform>` の形式で呼び出されることを想定しています。
この呼び出し方により、Pythonはプロジェクトのルートディレクトリ（`dotfiles`）をモジュール検索パスに自動的に追加します。この特性を最大限に活用し、以下の規約に従ってください。

-   **絶対インポートと相対インポートの利用**:
    -   `sys.path` を手動で操作する（`sys.path.append` など）ことは**避けてください**。これは、`python -m` 形式の恩恵を打ち消し、コードの可読性や保守性を損なう原因となります。
    -   プロジェクト内のモジュールをインポートする際は、プロジェクトのルートディレクトリ（`dotfiles`）を基準とした**絶対インポート**（例: `from deploy.shared.paths import HOME_DIR`）または、現在のモジュールからの相対パスを示す**相対インポート**（例: `from .paths import HOME_DIR` や `from ..handlers.some_handler import some_function`）を使用してください。
    -   これにより、コードの可読性が向上し、モジュールの移動やリファクタリングが容易になります。また、静的解析ツールがインポートを正しく解決できるようになります。

## 4. コード品質の維持

-   **リンティングと自動修正**: コードの品質と一貫性を保つため、`ruff` リンターを使用します。
    -   コードの変更後、コミット前に以下のコマンドを実行し、エラーや警告がないことを確認してください。
        ```bash
        python3 -m ruff check .
        ```
    -   修正可能なエラーは、以下のコマンドで自動修正できます。
        ```bash
        python3 -m ruff check . --fix
        ```
-   **コードフォーマット**: コードの見た目を統一するため、`ruff` フォーマッターを使用します。
    -   以下のコマンドを実行し、コードを整形してください。
        ```bash
        python3 -m ruff format .
        ```
    -   `ruff check . --fix` はリンティングエラーを修正しますが、コードのフォーマットは行いません。フォーマットを適用するには、別途 `ruff format .` を実行する必要があります。

## 5. ドキュメントの役割分担

-   **規約の役割**: この規約ファイルには、プロジェクト全体に適用される汎用的な「書き方のルール」や設計方針のみを記述します。
-   **コードの役割**: 個別のファイルや関数が「何をするか」という具体的な説明は、この規約には含めず、そのファイル自身のドキュメントコメント（docstring）に記述してください。これにより、コードの自己文書性を高め、規約をシンプルに保ちます。
