# コーディング規約

このドキュメントは、`tools` ディレクトリ内の Python スクリプトに関するコーディング規約を定めたものです。

## 1. 全体構成

`tools` ディレクトリは、`update` のような特定の目的を持つ複数のツールパッケージを格納します。

-   **ツールパッケージ**: `tools/<package_name>` のように、目的ごとにディレクトリを分けます。（例: `tools/update`, `tools/backup`）
-   **実行スクリプト (`__main__.py`)**: 各ツールパッケージのメインの処理は `__main__.py` に記述します。このスクリプトは、パッケージ内の各モジュールを呼び出す「司令塔」の役割に徹し、具体的なロジックは持ちすぎないようにします。
-   **機能モジュール**: ツールの具体的な機能は、独立したモジュール（Pythonファイル）として作成し、`__main__.py` から呼び出されるようにします。（例: `tools/update/updaters/update_brew.py`）
-   **共通モジュール**: パッケージ内で共通して利用する処理があれば、`shared` のようなディレクトリを作成して配置します。

## 2. モジュールの設計

-   **1ファイル = 1責務**: 各機能は、それぞれ独立したPythonファイル（モジュール）として作成します。（例: `update_brew.py` は Homebrew の更新にのみ責務を持つ）
-   **1ファイル = 1公開関数**: 各モジュールは、原則として外部に公開する（他のファイルから `import` して使う）関数を1つにします。
    -   公開する関数名は、モジュール名（ファイル名から `.py` を除いたもの）と同じにすることを推奨します。（例: `update_brew.py` なら `def update_brew():`）
    -   これにより、呼び出し側は `from <module_name> import <function_name>` という一貫した形式で利用できます。
-   **パスの管理**: 複数のスクリプトから参照される可能性のあるパスは、共通のモジュール（例: `shared/paths.py`）に変数としてまとめて定義し、各スクリプトからはその変数をインポートして利用します。これにより、パスの変更に強く、再利用性の高いコードを維持します。
-   **関数定義の順序**: ファイル内で複数の関数を定義する場合、外部に公開する関数をファイルの先頭に近い位置に記述し、その関数から呼び出されるプライベートなヘルパー関数（`_` で始まる関数）は、その後に記述してください。

## 3. 実行とインポートの管理

`tools` 内のスクリプトは、リポジトリルートの `bin/` ディレクトリに置かれたラッパースクリプト経由で実行されることを想定しています。
ラッパーでは `python3 -m tools.<package_name>` のように実行されるため、Pythonはプロジェクトのルートディレクトリをモジュール検索パスに自動的に追加します。この特性を最大限に活用し、以下の規約に従ってください。

-   **`sys.path` の操作を避ける**:
    -   `sys.path` を手動で操作する（`sys.path.append` など）ことは**避けてください**。これは、`python -m` 形式の恩恵を打ち消し、コードの可読性や保守性を損なう原因となります。
-   **絶対インポートと相対インポートの利用**:
    -   プロジェクト内のモジュールをインポートする際は、プロジェクトのルートディレクトリ（`dotfiles`）を基準とした**絶対インポート**（例: `from tools.update.updaters.update_brew import update_brew`）または、現在のモジュールからの相対パスを示す**相対インポート**（例: `from .updaters.update_brew import update_brew`）を使用してください。
    -   これにより、コードの可読性が向上し、モジュールの移動やリファクタリングが容易になります。また、静的解析ツールがインポートを正しく解決できるようになります。

## 4. コード品質の維持

-   **リンティングと自動修正**: コードの品質と一貫性を保つため、`ruff` リンターを使用します。
    -   コードの変更後、コミット前に以下のコマンドを実行し、エラーや警告がないことを確認してください。
        ```bash
        python3 -m ruff check .
        ```
    -   修正可能なエラーは、以下のコマンドで自動修正できます。
        ```bash
        python3 -m ruff check . --fix
        ```
-   **コードフォーマット**: コードの見た目を統一するため、`ruff` フォーマッターを使用します。
    -   以下のコマンドを実行し、コードを整形してください。
        ```bash
        python3 -m ruff format .
        ```
    -   `ruff check . --fix` はリンティングエラーを修正しますが、コードのフォーマットは行いません。フォーマットを適用するには、別途 `ruff format .` を実行する必要があります。

## 5. ドキュメントの役割分担

-   **規約の役割**: この規約ファイルには、プロジェクト全体に適用される汎用的な「書き方のルール」や設計方針のみを記述します。
-   **コードの役割**: 個別のファイルや関数が「何をするか」という具体的な説明は、この規約には含めず、そのファイル自身のドキュメントコメント（docstring）に記述してください。これにより、コードの自己文書性を高め、規約をシンプルに保ちます。
